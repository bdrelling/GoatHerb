name: Tests

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  # Prepare our workflow.
  prepare:
    name: Prepare
    uses: bdrelling/ci/.github/workflows/prepare.yml@main

  # Run our test script.
  swift_test:
    name: ${{ matrix.inputs.build-method }} test (${{ matrix.inputs.platform }}, swift ${{ matrix.inputs.swift-version }})
    runs-on: ${{ matrix.inputs.runner }}
    needs: [prepare]
    strategy:
      fail-fast: false
      matrix:
        inputs:
          - {
              runner: 'macos-12',
              platform: 'macOS',
              build-method: 'swift',
              swift-version: '5.5',
            }
          - {
              runner: 'macos-12',
              platform: 'macOS',
              build-method: 'swift',
              swift-version: '5.6',
            }
          - {
              runner: 'ubuntu-latest',
              platform: 'Linux',
              build-method: 'swift',
              swift-version: '5.5',
            }
          - {
              runner: 'ubuntu-latest',
              platform: 'Linux',
              build-method: 'swift',
              swift-version: '5.6',
            }
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run Tests
        # As of September 2022, we cannot reference local actions from a reusable workflow.
        uses: bdrelling/ci/.github/actions/swift-test@main
        env:
          GITHUB_ACCESS_TOKEN: ${{ github.token }}
        with:
          scheme: ${{ inputs.scheme }}
          platform: ${{ matrix.inputs.platform }}
          build-method: ${{ matrix.inputs.build-method }}
          swift-version: ${{ matrix.inputs.swift-version }}

  # Send notification to Discord on failure.
  send_notification:
    name: Send Notification
    uses: bdrelling/ci/.github/workflows/send_notification.yml@main
    needs: [swift_test]
    secrets: inherit
